"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports[Symbol.toStringTag]="Module";var l=require("typescript"),c=require("react"),E=require("react-dom");function y(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}var a=y(l),m=y(c),S=y(E);function b(t){let e=t;for(;e.parent;){if(a.default.isFunctionDeclaration(e))return e;if(a.default.isSourceFile(e))return null;e=e.parent}return null}function h(t){return e=>{const r=o=>{const n=a.default.visitEachChild(o,r,e);return a.default.isJsxOpeningElement(n)||a.default.isJsxSelfClosingElement(n)?j(t,n):n};return o=>a.default.factory.updateSourceFile(o,a.default.visitNodes(o.statements,r))}}const x=[/^[a-z]+$/];function j(t,e){if(a.default.isIdentifier(e.tagName)){const r=e.tagName.getText();if(!(t.target??x).some(v=>v.test(r)))return e;const n=e.getSourceFile(),s=n.fileName,d=a.default.getLineAndCharacterOfPosition(n,e.getStart(n)),i=e.kind===a.default.SyntaxKind.JsxOpeningElement?l.factory.createJsxOpeningElement:l.factory.createJsxSelfClosingElement,u=b(e),p=`${s.replace(t.projectRoot,"")}:${d.line+1}:${d.character+1}${u?` | [${u.name?.getText()}]`:""}`;let f=null;return t.inlineCode&&(f=e.getText()),i(e.tagName,e.typeArguments,l.factory.updateJsxAttributes(e.attributes,[...e.attributes.properties,l.factory.createJsxAttribute(l.factory.createIdentifier("data-sj-path"),l.factory.createStringLiteral(`idea://open?file=${encodeURIComponent(s)}&line=${d.line+1}&column=${d.character+1}`)),l.factory.createJsxAttribute(l.factory.createIdentifier("data-sj-display-name"),l.factory.createStringLiteral(p)),...f?[l.factory.createJsxAttribute(l.factory.createIdentifier("data-sj-code"),l.factory.createStringLiteral(encodeURIComponent(f)))]:[]]))}return e}const C=a.default.createPrinter();function L(t){return{enforce:"pre",transform(e,r){if(r.endsWith(".tsx")){const o=a.default.createSourceFile(r,e,a.default.ScriptTarget.Latest,!0,a.default.ScriptKind.TSX),n=a.default.transform(o,[h(t)]);return C.printNode(a.default.EmitHint.SourceFile,n.transformed[0],n.transformed[0])}}}}function J(){return{enforce:"pre",transform(t,e){if(e.endsWith(".ts")||e.endsWith(".tsx")){const r=encodeURIComponent(t);return t+`
//@ts-ignore
(globalThis.__files||={})['${e}'] = decodeURIComponent("${r}");`}}}}function R(){const[t,e]=c.useState(null),[r,o]=c.useState(!1);return c.useEffect(()=>{let n=null;const s=()=>{n!=null&&clearTimeout(n),!r&&o(!0),n=setTimeout(()=>{o(!1),n=null},100)},d=i=>{if(i.target instanceof HTMLElement){if(i.target.closest("[data-sj-ui]"))return;let u=i.target;u.dataset.sjPath||(u=u.closest("[data-sj-path]")),u==null?e(null):t!==u&&e(i.target)}};return addEventListener("mouseover",d),addEventListener("scroll",s),addEventListener("resize",s),()=>{removeEventListener("mouseover",d),removeEventListener("scroll",s),removeEventListener("resize",s)}},[]),r?null:t}function g(){const t=c.useRef(null),e=R(),[r,o]=c.useState(!1),[n,s]=c.useState(null);c.useEffect(()=>{const i=()=>{o(!1)},u=f=>{f.shiftKey&&f.altKey&&o(!0)},p=f=>{f.shiftKey&&o(!1),f.altKey&&o(!1)};return addEventListener("blur",i),addEventListener("keydown",u),addEventListener("keyup",p),()=>{removeEventListener("blur",i),removeEventListener("keydown",u),removeEventListener("keyup",p)}},[]),c.useEffect(()=>{if(!e||!t.current)return;const i=e.getBoundingClientRect();s({rect:i,sjPath:e.dataset.sjPath,sjDisplayName:e.dataset.sjDisplayName,sjCode:e.dataset.sjCode&&decodeURIComponent(e.dataset.sjCode)})},[e,s,t]);const d=e&&r;return m.default.createElement("div",{ref:t,style:{position:"fixed",background:"rgba(255,255,0,0.1)",visibility:d?"visible":"hidden",display:"grid",placeItems:"center",userSelect:"none",pointerEvents:"none",outline:"0.2rem dotted gray",boxSizing:"border-box",isolation:"isolate",left:n?.rect.left,top:n?.rect.top,width:n?.rect.width,height:n?.rect.height,cursor:"pointer"}},m.default.createElement("div",{style:{background:"rgba(0,0,255,0.5)",color:"#fff",padding:5,zIndex:1e4,borderRadius:4,pointerEvents:"auto"},onClick:()=>{const i=document.createElement("a");i.href=n?.sjPath,i.click()}},"\u{1F517} ",n?.sjDisplayName),n?.sjCode&&m.default.createElement("div",{style:{position:"absolute",right:0,bottom:0,fontFamily:"menlo, monospace",background:"rgba(0,0,255,0.8)",color:"white",borderRadius:2,padding:3,boxSizing:"border-box",zIndex:1e4,width:"100%",overflow:"scroll"}},m.default.createElement("pre",null,m.default.createElement("code",null,n?.sjCode))))}function I(){const[t,e]=c.useState(null);return c.useEffect(()=>{const r=document.createElement("div");return r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.zIndex="2147483647",r.style.pointerEvents="none",r.dataset.sjUi="true",document.body.appendChild(r),e(r),()=>{e(null),r.remove()}},[]),t==null?m.default.createElement(m.default.Fragment,null):S.default.createPortal(m.default.createElement(g,null),t)}exports.SourceJumpOverlay=g;exports.SourceJumpOverlayPortal=I;exports.embedSource=J;exports.tsxSourceJump=L;
